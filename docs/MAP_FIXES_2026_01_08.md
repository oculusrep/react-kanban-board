# Map Fixes - January 8, 2026

## Overview

This document describes bug fixes made to the Google Maps implementation in this session, addressing two issues:

1. **Site Submit Clustering** - "No Clustering" option was not working
2. **Google Places Labels Toggle** - Checkbox to toggle business labels was hidden

---

## Issue 1: Site Submit Clustering Not Disabling

### Problem

When users selected "No Clustering" in the Site Submit map settings, markers were still being clustered. The intention was that setting `minimumClusterSize` to a high value (999) would prevent clustering, but MarkerClusterer still grouped nearby markers.

### Root Cause

The `@googlemaps/markerclusterer` library doesn't respect extremely high `minimumClusterSize` values as a way to disable clustering. It still processes and groups markers regardless of the threshold setting.

### Solution

Modified `SiteSubmitLayer.tsx` to bypass the MarkerClusterer entirely when "No Clustering" is selected:

#### Change 1: Detect and bypass clustering

```typescript
// In the clusterer initialization useEffect
if (clusterConfig.minimumClusterSize >= 100) {
  console.log(`ðŸš« Clustering disabled (minimumClusterSize: ${clusterConfig.minimumClusterSize})`);
  setClusterer(null);
  return;
}
```

#### Change 2: Handle null clusterer in marker visibility

```typescript
// In updateMarkerVisibility function
if (!clusterer) {
  // No clustering - add markers directly to map
  console.log(`ðŸ‘ï¸ Showing ${markersToCluster.length} site submit markers (no clustering)`);
  markersToCluster.forEach(marker => marker.setMap(map));
} else {
  // Use clusterer
  clusterer.addMarkers(markersToCluster);
}
```

#### Change 3: Add dependency to useEffect

Added `loadingConfig.clusterConfig` to the useEffect dependency array to ensure the clusterer reinitializes when cluster settings change.

### Files Modified

- [SiteSubmitLayer.tsx](../src/components/mapping/layers/SiteSubmitLayer.tsx)

### Testing

1. Navigate to the Site Submit map view
2. Click the Settings gear icon
3. Select "No Clustering" from the cluster options
4. Verify that markers appear individually without being grouped

---

## Issue 2: Google Places Labels Toggle Hidden

### Problem

The checkbox to toggle Google Places/business labels on the map was not visible, even though the functionality was previously working.

### Root Cause

Two issues were found in `GoogleMapContainer.tsx`:

1. The labels checkbox container was set to `display: 'none'` by default
2. References to a non-existent function `createNoLabelsStyle()` were causing errors

### Solution

#### Fix 1: Make labels checkbox visible

Changed the labels container from hidden to visible:

```typescript
// Before
labelsContainer.style.display = 'none';

// After
labelsContainer.style.display = 'flex'; // Always visible so users can toggle business labels
```

#### Fix 2: Correct function reference

Fixed two occurrences where `createNoLabelsStyle()` was called (this function doesn't exist):

```typescript
// Before (incorrect)
styles: labelsVisible ? createMutedPlacesStyle() : [...createMutedPlacesStyle(), ...createNoLabelsStyle()]

// After (correct)
styles: labelsVisible ? createMutedPlacesStyle() : [...createMutedPlacesStyle(), ...createNoPlacesStyle()]
```

The correct function is `createNoPlacesStyle()` which sets `poi.business` visibility to "off".

### Files Modified

- [GoogleMapContainer.tsx](../src/components/mapping/GoogleMapContainer.tsx)

### Testing

1. Open any map view (Properties, Site Submits, etc.)
2. Look for the "Business Labels" checkbox in the map controls
3. Toggle the checkbox and verify that business POI labels appear/disappear on the map

---

## Map Styling Functions Reference

The map uses these styling functions from `src/components/mapping/mapStyles.ts`:

| Function | Purpose |
|----------|---------|
| `createMutedPlacesStyle()` | Mutes POI labels but keeps them visible |
| `createNoPlacesStyle()` | Hides POI labels completely (`visibility: 'off'`) |
| `createNoLandmarksStyle()` | Hides landmark POI icons |

---

## Related Documentation

- [ADVANCED_MAP_FEATURES_PLAN.md](./ADVANCED_MAP_FEATURES_PLAN.md) - Future map feature roadmap
- [GPS_TRACKING_COMPLETE_2025_10_12.md](./GPS_TRACKING_COMPLETE_2025_10_12.md) - GPS tracking implementation
- [MARKER_STYLES_REFERENCE.md](./MARKER_STYLES_REFERENCE.md) - Map marker styling guide

---

## Session Summary

| Issue | File | Fix Type |
|-------|------|----------|
| Clustering not disabling | SiteSubmitLayer.tsx | Bypass clusterer when minimumClusterSize >= 100 |
| Labels toggle hidden | GoogleMapContainer.tsx | Set display: 'flex' and fix function name |

Both fixes are backward-compatible and do not affect other map functionality.
